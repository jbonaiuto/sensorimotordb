{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
<title>MirrorDB - View Condition: {{ object.name }}</title>
<link href="{% static 'mirrordb/js/video-js/video-js.css' %}" rel="stylesheet">
<script type="text/javascript" src="{% static 'mirrordb/js/jquery-1.10.1.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/d3.min.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/underscore-min.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/neural_data_functions.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/condition_neural_data_plot.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/video-js/video.dev.js' %}"></script>
<script>

    videojs.options.flash.swf = "{{ site_url }}/static/mirrordb/js/video-js/video-js.swf";
    document.createElement('video');document.createElement('audio');document.createElement('track');

    $(document).ready(function(){
        var data = {};
        var args = {
            type: "GET",
            url: "/mirrordb/api/v1/grasp_observation_condition/{{ object.id }}/?format=json",
            data: data,
            success: loadedConditionData,
            error: function(data) {
                alert("Something went wrong!");
            } };
        $.ajax(args)
    });

    var unit_ids=[];

    function loadedConditionData(resp){
        resp.video_url_mp4='{{ video_url_mp4 }}';
        $('.condition_info').each(function(index, element){
            $(this).empty();
            var tmplMarkup = $('#grasp_observation_condition-template').html();
            var compiledTmpl = _.template(tmplMarkup, resp);
            $(this).append(compiledTmpl);
        });

        var unit_trials=new Map();
        var unit_trial_events=new Map();
        var units=new Map();
        var event_types=['start'];

        for(var i=0; i<resp.recording_trials.length; i++)
        {
            var recording_trial=loadObject(resp.recording_trials[i]);
            var trial_number=recording_trial.trial_number;
            var start_time=parseFloat(recording_trial.start_time);

            for(var j=0; j<recording_trial.unit_recordings.length; j++)
            {
                var unit_recording=loadObject(recording_trial.unit_recordings[j]);
                var unit=unit_recording.unit;

                if(unit_ids.indexOf(unit.id)<0)
                {
                    unit_ids.push(unit.id);
                    units.set(unit.id, unit);
                    unit_trials.set(unit.id,[]);
                    unit_trial_events.set(unit.id,[]);
                }

                unit_trial_events.get(unit.id).push({
                    t: start_time,
                    trial: trial_number,
                    name: 'start',
                    description: 'trial start'
                });
                for(var k=0; k<recording_trial.events.length; k++)
                {
                    var event=recording_trial.events[k];
                    unit_trial_events.get(unit.id).push({
                        t: parseFloat(event.time),
                        trial: trial_number,
                        name: event.name,
                        description: event.description
                    });
                    if(event_types.indexOf(event.name)<0)
                        event_types.push(event.name);
                }

                var unit_data=[];
                var spike_times=unit_recording.spike_times.split(',');
                for(var k=0; k<spike_times.length; k++)
                {
                    unit_trials.get(unit.id).push({
                        x: parseFloat(spike_times[k]),
                        y: trial_number
                    });
                }
            }
        }
        drawPopulationFiringRate(unit_trials, unit_trial_events, event_types);

        $('.unit_list').each(function(index, element){
            $(this).empty();
        });
        for(var i=0; i<unit_ids.length; i++)
        {
            var unit=units.get(unit_ids[i]);
            $('.unit_list').each(function(index, element){
                unit.level=3;
                unit.idx=i;
                var tmplMarkup = $('#unit-template').html();
                var compiledTmpl = _.template(tmplMarkup, unit);
                $(this).append(compiledTmpl);
            });
            var single_unit_trials=unit_trials.get(unit.id);
            var single_unit_trial_events=unit_trial_events.get(unit.id);
            drawRaster(unit.id, single_unit_trials, single_unit_trial_events, event_types);

            drawHistogram(unit.id, single_unit_trials, single_unit_trial_events, event_types);

            drawFiringRate(unit.id, single_unit_trials, single_unit_trial_events, event_types);
        }
    }
</script>
{% endblock %}
{% block content %}
    <div id="main" class="main">
        <div class="condition_info"></div>
        <h2>Unit Recordings</h2>
        <div class="unit_list"></div>
    </div>
    {% include "mirrordb/condition/grasp_observation_condition_template.html" %}
    {% include "mirrordb/unit/unit_list_item_template.html" %}
{% endblock %}