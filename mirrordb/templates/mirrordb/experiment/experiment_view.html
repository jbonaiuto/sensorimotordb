{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
<title>MirrorDB - View Experiment: {{ object.title }}</title>
<script type="text/javascript" src="{% static 'mirrordb/js/jquery-1.10.1.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/d3.min.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/underscore-min.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/neural_data_functions.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/experiment_neural_data_plot.js' %}"></script>
<script>

    $(document).ready(function(){
        var data = {};
        var args = {
            type: "GET",
            url: "/mirrordb/api/v1/experiment/{{ object.id }}/?limit=0&format=json",
            data: data,
            success: loadedExperimentData,
            error: function(data) {
                alert("Something went wrong!");
            } };
        $.ajax(args);
    });

    var condition_ids=[];
    var unit_ids=[];

    function loadedExperimentData(resp){
        $('.experiment_info').each(function(index, element){
            $(this).empty();
            var tmplMarkup = $('#experiment-template').html();
            var compiledTmpl = _.template(tmplMarkup, resp);
            $(this).append(compiledTmpl);
        });
        loadConditions();
    }

    function loadConditions(){
        $('.condition_list').each(function(index, element){
            $(this).empty();
        });
        $('.unit_list').each(function(index, element){
            $(this).empty();
        });
        var data = {};
        var args = {
            type: "GET",
            url: "/mirrordb/api/v1/condition/?experiment={{ object.id }}&limit=0&format=json",
            data: data,
            success: loadedConditionData,
            error: function(data) {
                alert("Something went wrong!");
            } };
        $.ajax(args);
    }

    var condition_names=[];
    var all_unit_condition_trials=new Map();
    var all_unit_condition_trial_events=new Map();
    var conditions_to_load=0;

    function loadedConditionData(resp)
    {
        conditions_to_load = resp.objects.length;
        for(var i=0; i<resp.objects.length; i++)
        {
            var condition=resp.objects[i];
            condition_ids.push(condition.id);
            condition_names.push(condition.name);

            $('.condition_list').each(function(index, element){
                condition.level=3;
                condition.idx=i;
                var tmplMarkup = $('#condition-template').html();
                var compiledTmpl = _.template(tmplMarkup, condition);
                $(this).append(compiledTmpl);
            });

            var data = {};
            var args = {
                type: "GET",
                url: "/mirrordb/api/v1/full_recording_trial/?condition="+condition.id+"&limit=0&format=json",
                data: data,
                success: loadedRecordingTrialData,
                error: function(data) {
                    alert("Something went wrong!");
                } };
            $.ajax(args);
        }
    }

    function loadedRecordingTrialData(resp)
    {
        var condition_unit_ids=[];
        var unit_trials=new Map();
        var unit_trial_events=new Map();
        var units=new Map();
        var event_types=['start'];

        for(var j=0; j<resp.objects.length; j++)
        {
            var recording_trial=resp.objects[j];
            var condition_id=parseInt(recording_trial.condition.split('/')[5]);
            var trial_number=recording_trial.trial_number;
            var start_time=parseFloat(recording_trial.start_time);

            for(var k=0; k<recording_trial.unit_recordings.length; k++)
            {
                var unit_recording=recording_trial.unit_recordings[k];
                var unit=unit_recording.unit;

                if(condition_unit_ids.indexOf(unit.id)<0)
                {
                    condition_unit_ids.push(unit.id);
                    units.set(unit.id, unit);
                    unit_trials.set(unit.id,[]);
                    unit_trial_events.set(unit.id,[]);
                    if(unit_ids.indexOf(unit.id)<0)
                    {
                        unit_ids.push(unit.id);
                        all_unit_condition_trials.set(unit.id, new Map());
                        all_unit_condition_trial_events.set(unit.id, new Map());
                        $('.unit_list').each(function(index, element){
                            unit.level=3;
                            unit.idx=unit_ids.length-1;
                            var tmplMarkup = $('#unit-template').html();
                            var compiledTmpl = _.template(tmplMarkup, unit);
                            $(this).append(compiledTmpl);
                        });
                    }
                }

                unit_trial_events.get(unit.id).push({
                    t: start_time,
                    trial: trial_number,
                    name: 'start',
                    description: 'trial start'
                });
                for(var l=0; l<recording_trial.events.length; l++)
                {
                    var event=recording_trial.events[l];
                    unit_trial_events.get(unit.id).push({
                        t: parseFloat(event.time),
                        trial: trial_number,
                        name: event.name,
                        description: event.description
                    });
                    if(event_types.indexOf(event.name)<0)
                        event_types.push(event.name);
                }

                if(all_unit_condition_trial_events.get(unit.id).get(condition_id)==null)
                    all_unit_condition_trial_events.get(unit.id).set(condition_id,[]);
                all_unit_condition_trial_events.get(unit.id).get(condition_id).push({
                    t: start_time,
                    trial: trial_number,
                    name: 'start',
                    description: 'trial start'
                });
                for(var l=0; l<recording_trial.events.length; l++)
                {
                    var event=recording_trial.events[l];
                    all_unit_condition_trial_events.get(unit.id).get(condition_id).push({
                        t: parseFloat(event.time),
                        trial: trial_number,
                        name: event.name,
                        description: event.description
                    });
                }

                if(all_unit_condition_trials.get(unit.id).get(condition_id)==null)
                    all_unit_condition_trials.get(unit.id).set(condition_id,[]);

                var unit_data=[];
                var spike_times=unit_recording.spike_times.split(',');
                for(var l=0; l<spike_times.length; l++)
                {
                    unit_trials.get(unit.id).push({
                        x: parseFloat(spike_times[l]),
                        y: trial_number
                    });
                    all_unit_condition_trials.get(unit.id).get(condition_id).push({
                        x: parseFloat(spike_times[l]),
                        y: trial_number
                    });
                }
            }
        }
        drawConditionPopulationFiringRate(condition_id, unit_trials, unit_trial_events, event_types, condition_unit_ids);

        conditions_to_load=conditions_to_load-1;

        if(conditions_to_load==0)
        {
            for(var i=0; i<unit_ids.length; i++)
            {
                var unit_id=unit_ids[i];
                drawUnitPopulationFiringRate(unit_id, all_unit_condition_trials.get(unit_id),
                        all_unit_condition_trial_events.get(unit_id), event_types, condition_names);
            }
        }
    }
</script>
{% endblock %}
{% block content %}
<div id="main" class="main">
    <div class="experiment_info"></div>
    <form>
        <label for="binwidth">Bin width</label>
        <select id="binwidth">
            <option selected value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
        </select>
        <input id="align_event" type="hidden" value="start"/>
    </form>
    <h2>Conditions</h2>
    <div class="condition_list"></div>
    <h2>Units</h2>
    <div class="unit_list"></div>
</div>
{% include "mirrordb/experiment/experiment_template.html" %}
{% include "mirrordb/condition/condition_list_item_template.html" %}
{% include "mirrordb/unit/unit_list_item_template.html" %}
{% endblock %}