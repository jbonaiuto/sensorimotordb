{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
<title>MirrorDB - View Unit: {{ object.id }}</title>
<script type="text/javascript" src="{% static 'mirrordb/js/jquery-1.10.1.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/d3.min.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/underscore-min.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/neural_data_functions.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/unit_neural_data_plot.js' %}"></script>
<script type="text/javascript" src="{% static 'mirrordb/js/neural_data_plot.js' %}"></script>
<script>

    $(document).ready(function(){
        var data = {};
        var args = {
            type: "GET",
            url: "/mirrordb/api/v1/unit/{{ object.id }}/?limit=0&format=json",
            data: data,
            success: loadedUnitData,
            error: function(data) {
                alert("Something went wrong!");
            } };
        $.ajax(args);
    });

    var condition_ids=[];
    var condition_names=[];
    var condition_trials=new Map();
    var condition_trial_events=new Map();
    var conditions=new Map();
    var event_types=['start'];

    function loadedUnitData(resp){
        $('.unit_info').each(function(index, element){
            $(this).empty();
            var tmplMarkup = $('#unit-template').html();
            var compiledTmpl = _.template(tmplMarkup, resp);
            $(this).append(compiledTmpl);
        });
        var data = {};
        var args = {
            type: "GET",
            url: "/mirrordb/api/v1/unit_recording/?unit={{ object.id }}&limit=0&format=json",
            data: data,
            success: loadedUnitRecordingData,
            error: function() {
                alert("Something went wrong!");
            } };
        $.ajax(args);
    }

    var recording_trial_map=new Map();

    function getRecordingTrial(resource_uri)
    {
        if(recording_trial_map.get(resource_uri)==null)
            recording_trial_map.set(resource_uri, loadObject(resource_uri));
        var recording_trial=recording_trial_map.get(resource_uri);
        return recording_trial;
    }

    var condition_map=new Map();

    function getCondition(resource_uri)
    {
        if(condition_map.get(resource_uri)==null)
            condition_map.set(resource_uri, loadObject(resource_uri));
        var condition=condition_map.get(resource_uri);
        return condition;
    }

    var condition_trial_map=new Map();
    function loadedUnitRecordingData(resp)
    {
        $('.condition_list').each(function(index, element){
            $(this).empty();
        });

        var trial_condition_list=new Map();

        // Iterate through unit recordings
        for(var i=0; i<resp.objects.length; i++)
        {
            // Current unit recording
            var unit_recording=resp.objects[i];

            var recording_trial=getRecordingTrial(unit_recording.trial);
            if(recording_trial!=null)
            {
                var condition=getCondition(recording_trial.condition);
                if(condition!=null)
                {
                    if(condition_ids.indexOf(condition.id)<0)
                    {
                        condition_ids.push(condition.id);
                        condition_names.push(condition.name);
                        conditions.set(condition.id, condition);
                        condition_trials.set(condition.id, []);
                        condition_trial_events.set(condition.id, []);
                        condition_trial_map.set(condition.id,[]);

                        $('.condition_list').each(function(index, element){
                            condition.level=3;
                            condition.idx=condition_ids.length-1;
                            var tmplMarkup = $('#condition-template').html();
                            var compiledTmpl = _.template(tmplMarkup, condition);
                            $(this).append(compiledTmpl);
                        });
                    }
                    if(condition_trial_map.get(condition.id).indexOf(recording_trial.id)<0)
                    {
                        condition_trial_map.get(condition.id).push(recording_trial.id);
                        var trial_number=recording_trial.trial_number;
                        var start_time=parseFloat(recording_trial.start_time);
                        condition_trial_events.get(condition.id).push({
                            t: start_time,
                            trial: trial_number,
                            name: 'start',
                            description: 'trial start'
                        });

                        for(var k=0; k<recording_trial.events.length; k++)
                        {
                            var event=recording_trial.events[k];
                            condition_trial_events.get(condition.id).push({
                                t: parseFloat(event.time),
                                trial: trial_number,
                                name: event.name,
                                description: event.description
                            });
                            if(event_types.indexOf(event.name)<0)
                                event_types.push(event.name);
                        }
                    }
                    var trial_number=recording_trial.trial_number;
                    var unit_data=[];
                    var spike_times=unit_recording.spike_times.split(',');
                    for(var k=0; k<spike_times.length; k++)
                    {
                        condition_trials.get(condition.id).push({
                            x: parseFloat(spike_times[k]),
                            y: trial_number
                        });
                    }
                }
                else
                    alert('Couldnt get condition!');
            }
            else
                alert('Couldnt get recording trial!');
        }

        drawPopulationFiringRate(condition_trials, condition_trial_events, event_types, condition_names);
        for(var i=0; i<condition_ids.length; i++)
        {
            var condition_id=condition_ids[i];
            var single_condition_trials=condition_trials.get(condition_id);
            var single_condition_trial_events=condition_trial_events.get(condition_id);
            drawRaster('condition-'+condition_id+'-plots', single_condition_trials, single_condition_trial_events, event_types);

            drawHistogram(condition_id, single_condition_trials, single_condition_trial_events, event_types);

            drawFiringRate(condition_id, single_condition_trials, single_condition_trial_events, event_types);
        }

    }

</script>
{% endblock %}
{% block content %}
<div id="main" class="main">
    <div class="unit_info"></div>
    <form>
        <label for="binwidth">Bin width</label>
        <select id="binwidth">
            <option selected value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
        </select>
        <input id="align_event" type="hidden" value="start"/>
    </form>
    <h2>Conditions</h2>
    <div class="condition_list"></div>
</div>
{% include "mirrordb/unit/unit_template.html" %}
{% include "mirrordb/condition/condition_list_item_template.html" %}
{% endblock %}