{% extends "base.html" %}
{% load staticfiles %}
{% block extrahead %}
<title>SensoriMotorDB - Create Visuomotor Classification Analysis</title>
<script type="text/javascript" src="{% static 'sensorimotordb/js/jquery-1.10.1.js' %}"></script>
<script type="text/javascript" src="{% static 'sensorimotordb/js/d3.min.js' %}"></script>
<script type="text/javascript">
    $(document).ready(function(){

        var data = {};
        var args = {
            type: "GET",
            url: "/sensorimotordb/api/v1/event/?format=json&trial__condition__experiment={{ form.experiment.value }}",
            data: data,
            success: loadedEvents,
            error: function(data) {
                //alert("Something went wrong!");
            } };
        $.ajax(args);
    });

    function loadedEvents(resp)
    {
        var eventTimes=new Map();
        var durations=[];
        for(var idx=0; idx<resp.objects.length; idx++)
        {
            var event=resp.objects[idx];
            if(!eventTimes.has(event.name))
                eventTimes.set(event.name,[]);
            eventTimes.get(event.name).push((event.time-event.trial.start_time)*1000.0);
            durations.push((event.trial.end_time-event.trial.start_time)*1000.0);
        }
        var eventMeanTimes=new Map();
        for(let event_name of eventTimes.keys())
        {
            var times=eventTimes.get(event_name);
            eventMeanTimes.set(event_name, d3.mean(times));
        }
        drawWOIPicker('analysis_woi_picker', 0, d3.mean(durations), eventMeanTimes);
    }

    var dispatch=d3.dispatch("statechange","woi_modified");

    function drawWOIPicker(parent_id, min_time, max_time, eventMeanTimes)
    {
        var p=d3.scale.category10();
        var margin = {top: 30, right: 0, bottom: 40, left: 50}
                , width = 700 - margin.left - margin.right
                , height = 400 - margin.top - margin.bottom;

        var rate_svg = d3.select("#"+parent_id)
                .append("svg:svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var xScale = d3.scale.linear()
                .range([0, width])
                .domain([min_time, max_time]);

        var yScale = d3.scale.linear()
                .range([height, 0])
                .domain([0,1]);

        var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom");

        var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left");
                //.tickFormat(function (d) { return ''; });;

        rate_svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        rate_svg.append("svg:g")
                .attr("class", "y axis")
                .call(yAxis);

        rate_svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width/2)
                .attr("y", height + margin.bottom)
                .text("Time (ms)");

        // Events
        var baseline_rel=d3.select("#id_baseline_rel_evt").node().value;
        var baseline_rel_start=parseFloat(d3.select("#id_baseline_rel_start").node().value);
        var baseline_rel_end=parseFloat(d3.select("#id_baseline_rel_end").node().value);
        var baseline_rel_time=eventMeanTimes.get(baseline_rel);
        var baseline_woi=rate_svg.append("rect")
                        .attr("x", xScale(baseline_rel_time+baseline_rel_start))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(baseline_rel_end-baseline_rel_start))
                        .attr("height",yScale(0.2))
                        .attr("opacity",0.25);
        var baseline_woi_label=rate_svg.selectAll(".g-note")
                .data(['Baseline'])
                .enter().append("text")
                .classed("annotation-text",true)
                .style('fill', "black")
                .attr("x", baseline_rel_time+(xScale(baseline_rel_start+0.5*(baseline_rel_end-baseline_rel_start))))
                .attr("y", yScale(0.8))
                .attr("dy", function(d, i) { return i * 1.3 + "em"; })
                .text(function(d) { return d; });
        if((baseline_rel_end-baseline_rel_start)==0 || isNaN(baseline_rel_start) || isNaN(baseline_rel_end))
        {
            baseline_woi_label.style('opacity',0.0);
        }

        var object_view_rel=d3.select("#id_obj_view_woi_rel_evt").node().value;
        var object_view_rel_start=parseFloat(d3.select("#id_obj_view_woi_rel_start").node().value);
        var object_view_rel_end=parseFloat(d3.select("#id_obj_view_woi_rel_end").node().value);
        var object_view_rel_time=eventMeanTimes.get(object_view_rel);
        var object_view_woi=rate_svg.append("rect")
                .attr("x", xScale(object_view_rel_time+object_view_rel_start))
                .attr("y", yScale(0.8))
                .attr("width", xScale(object_view_rel_end-object_view_rel_start))
                .attr("height",yScale(0.2))
                .attr("opacity",0.25);
        var object_view_woi_label=rate_svg.selectAll(".g-note")
                .data(['Object View'])
                .enter().append("text")
                .classed("annotation-text",true)
                .style('fill', "black")
                .attr("x", xScale(object_view_rel_time+(object_view_rel_start+0.5*(object_view_rel_end-object_view_rel_start))))
                .attr("y", yScale(0.8))
                .attr("dy", function(d, i) { return i * 1.3 + "em"; })
                .text(function(d) { return d; });
        if((object_view_rel_end-object_view_rel_start)==0 || isNaN(object_view_rel_start) || isNaN(object_view_rel_end))
        {
            object_view_woi_label.style('opacity',0.0);
        }

        var grasp_rel=d3.select("#id_grasp_woi_rel_evt").node().value;
        var grasp_rel_start=parseFloat(d3.select("#id_grasp_woi_rel_start").node().value);
        var grasp_rel_end=parseFloat(d3.select("#id_grasp_woi_rel_end").node().value);
        var grasp_rel_time=eventMeanTimes.get(grasp_rel);
        var grasp_woi=rate_svg.append("rect")
                .attr("x", xScale(grasp_rel_time+grasp_rel_start))
                .attr("y", yScale(0.8))
                .attr("width", xScale(grasp_rel_end-grasp_rel_start))
                .attr("height",yScale(0.2))
                .attr("opacity",0.25);
        var grasp_woi_label=rate_svg.selectAll(".g-note")
                .data(['Grasp'])
                .enter().append("text")
                .classed("annotation-text",true)
                .style('fill', "black")
                .attr("x", xScale(grasp_rel_time+(grasp_rel_start+0.5*(grasp_rel_end-grasp_rel_start))))
                .attr("y", yScale(0.8))
                .attr("dy", function(d, i) { return i * 1.3 + "em"; })
                .text(function(d) { return d; });
        if((grasp_rel_end-grasp_rel_start)==0 || isNaN(grasp_rel_start) || isNaN(grasp_rel_end))
        {
            grasp_woi_label.style('opacity',0.0);
        }

        var idx=0;
        for(let event_name of eventMeanTimes.keys())
        {
            var mean_time=eventMeanTimes.get(event_name);
            rate_svg.append("line")
                    .attr("x1", xScale(mean_time))
                    .attr("y1", yScale(0))
                    .attr("x2", xScale(mean_time))
                    .attr("y2", yScale(.9))
                    .classed("annotation-line",true)
            rate_svg.selectAll(".g-note")
                    .data([event_name])
                    .enter().append("text")
                    .classed("annotation-text",true)
                    .style('fill', p(idx))
                    .attr("x", xScale(mean_time))
                    .attr("y", yScale(.9))
                    .attr("dy", function(d, i) { return i * 1.3 + "em"; })
                    .text(function(d) { return d; });
            idx++;
        }

        d3.selectAll("#id_baseline_rel_type").on("change", function(){update();});
        d3.selectAll("#id_baseline_rel_evt").on("change", function(){update();});
        d3.selectAll("#id_baseline_rel_start").on("change", function(){update();});
        d3.selectAll("#id_baseline_rel_end").on("change", function(){update();});
        d3.selectAll("#id_baseline_rel_end_evt").on("change", function(){update();});

        d3.selectAll("#id_obj_view_woi_rel_type").on("change", function(){update();});
        d3.selectAll("#id_obj_view_woi_rel_evt").on("change", function(){update();});
        d3.selectAll("#id_obj_view_woi_rel_start").on("change", function(){update();});
        d3.selectAll("#id_obj_view_woi_rel_end").on("change", function(){update();});
        d3.selectAll("#id_obj_view_woi_rel_end_evt").on("change", function(){update();});

        d3.selectAll("#id_grasp_woi_rel_evt").on("change", function(){update();});
        d3.selectAll("#id_grasp_woi_rel_start").on("change", function(){update();});
        d3.selectAll("#id_grasp_woi_rel_end").on("change", function(){update();});
        d3.selectAll("#id_grasp_woi_rel_end_evt").on("change", function(){update();});

        function update()
        {
            var baseline_rel_evt=d3.select("#id_baseline_rel_evt").node().value;
            var baseline_rel_type=d3.select("#id_baseline_rel_type").node().value;
            if(baseline_rel_type=='relative')
            {
                var baseline_rel_end_evt=d3.select("#id_baseline_rel_end_evt").node().value;
                var baseline_rel_start_time=eventMeanTimes.get(baseline_rel_evt);
                var baseline_rel_end_time=eventMeanTimes.get(baseline_rel_end_evt);
                baseline_woi.attr("x", xScale(baseline_rel_start_time))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(baseline_rel_end_time-baseline_rel_start_time))
                        .attr("height", yScale(0.2));
                baseline_woi_label.attr("x",xScale(baseline_rel_start_time+0.5*(baseline_rel_end_time-baseline_rel_start_time)));
                if(!isNaN(baseline_rel_start_time) && !isNaN(baseline_rel_end_time) && (baseline_rel_end_time-baseline_rel_start_time)>0)
                    baseline_woi_label.style('opacity',1.0);
                else
                    baseline_woi_label.style('opacity',0.0);
            }
            else
            {
                var baseline_rel_start=parseFloat(d3.select("#id_baseline_rel_start").node().value);
                var baseline_rel_end=parseFloat(d3.select("#id_baseline_rel_end").node().value);
                var baseline_rel_time=eventMeanTimes.get(baseline_rel_evt);
                baseline_woi.attr("x", xScale(baseline_rel_time+baseline_rel_start))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(baseline_rel_end-baseline_rel_start))
                        .attr("height", yScale(0.2));
                baseline_woi_label.attr("x",xScale(baseline_rel_time+(baseline_rel_start+0.5*(baseline_rel_end-baseline_rel_start))));
                if(!isNaN(baseline_rel_start) && !isNaN(baseline_rel_end) && (baseline_rel_end-baseline_rel_start)>0)
                    baseline_woi_label.style('opacity',1.0);
                else
                    baseline_woi_label.style('opacity',0.0);
            }


            var object_view_rel_evt=d3.select("#id_obj_view_woi_rel_evt").node().value;
            var object_view_rel_type=d3.select("#id_obj_view_woi_rel_type").node().value;
            if(object_view_rel_type=='relative')
            {
                var object_view_rel_end_evt=d3.select("#id_obj_view_woi_rel_end_evt").node().value;
                var object_view_rel_start_time=eventMeanTimes.get(object_view_rel_evt);
                var object_view_rel_end_time=eventMeanTimes.get(object_view_rel_end_evt);
                object_view_woi.attr("x", xScale(object_view_rel_start_time))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(object_view_rel_end_time-object_view_rel_start_time))
                        .attr("height", yScale(0.2));
                object_view_woi_label.attr("x",xScale(object_view_rel_start_time+0.5*(object_view_rel_end_time-object_view_rel_start_time)));
                if(!isNaN(object_view_rel_start_time) && !isNaN(object_view_rel_end_time) && (object_view_rel_end_time-object_view_rel_start_time)>0)
                    object_view_woi_label.style('opacity',1.0);
                else
                    object_view_woi_label.style('opacity',0.0);
            }
            else
            {
                var object_view_rel_start=parseFloat(d3.select("#id_obj_view_woi_rel_start").node().value);
                var object_view_rel_end=parseFloat(d3.select("#id_obj_view_woi_rel_end").node().value);
                var object_view_rel_time=eventMeanTimes.get(object_view_rel_evt);
                object_view_woi.attr("x", xScale(object_view_rel_time+object_view_rel_start))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(object_view_rel_end-object_view_rel_start))
                        .attr("height", yScale(0.2));
                object_view_woi_label.attr("x",xScale(object_view_rel_time+(object_view_rel_start+0.5*(object_view_rel_end-object_view_rel_start))));
                if(!isNaN(object_view_rel_start) && !isNaN(object_view_rel_end) && (object_view_rel_end-object_view_rel_start)>0)
                    object_view_woi_label.style('opacity',1.0);
                else
                    object_view_woi_label.style('opacity',0.0);
            }

            var grasp_rel_evt=d3.select("#id_grasp_woi_rel_evt").node().value;
            var grasp_rel_type=d3.select("#id_grasp_woi_rel_type").node().value;
            if(grasp_rel_type=='relative')
            {
                var grasp_rel_end_evt=d3.select("#id_grasp_woi_rel_end_evt").node().value;
                var grasp_rel_start_time=eventMeanTimes.get(grasp_rel_evt);
                var grasp_rel_end_time=eventMeanTimes.get(grasp_rel_end_evt);
                grasp_woi.attr("x", xScale(grasp_rel_start_time))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(grasp_rel_end_time-grasp_rel_start_time))
                        .attr("height", yScale(0.2));
                grasp_woi_label.attr("x",xScale(grasp_rel_start_time+0.5*(grasp_rel_end_time-grasp_rel_start_time)));
                if(!isNaN(grasp_rel_start_time) && !isNaN(grasp_rel_end_time) && (grasp_rel_end_time-grasp_rel_start_time)>0)
                    grasp_woi_label.style('opacity',1.0);
                else
                    grasp_woi_label.style('opacity',0.0);
            }
            else
            {
                var grasp_rel_start=parseFloat(d3.select("#id_grasp_woi_rel_start").node().value);
                var grasp_rel_end=parseFloat(d3.select("#id_grasp_woi_rel_end").node().value);
                var grasp_rel_time=eventMeanTimes.get(grasp_rel_evt);
                grasp_woi.attr("x", xScale(grasp_rel_time+grasp_rel_start))
                        .attr("y", yScale(0.8))
                        .attr("width", xScale(grasp_rel_end-grasp_rel_start))
                        .attr("height", yScale(0.2));
                grasp_woi_label.attr("x",xScale(grasp_rel_time+(grasp_rel_start+0.5*(grasp_rel_end-grasp_rel_start))));
                if(!isNaN(grasp_rel_start) && !isNaN(grasp_rel_end) && (grasp_rel_end-grasp_rel_start)>0)
                    grasp_woi_label.style('opacity',1.0);
                else
                    grasp_woi_label.style('opacity',0.0);
            }
        }
    }

    function setWOIRelType(woi)
    {
        var val=$("#id_"+woi+"_rel_type").val();
        if(val=='fixed')
        {
            $('.'+woi+'_fixed').show();
            $('.'+woi+'_relative').hide();
            $('#id_'+woi+'_rel_end_evt').val('');
        }
        else
        {
            $('.'+woi+'_fixed').hide();
            $('.'+woi+'_relative').show();
            $('#id_'+woi+'_rel_start').val('');
            $('#id_'+woi+'_rel_end').val('');
        }
    }
</script>
{% endblock %}
{% block content %}
<h2>New Visuomotor Classification Analysis</h2>
<div id="analysis_woi_picker" style="text-align:center"></div>
<form id="analysisForm" method="post" action="" enctype="multipart/form-data">
    {% csrf_token %}
    <table>
        <tr>
            <td>
                <strong>{{ form.name.label_tag }}</strong>
            </td>
            <td colspan="3">
                {{ form.name }}
            </td>
        </tr>
        <tr>
            <td>
                <strong>{{ form.description.label_tag }}</strong>
            </td>
            <td colspan="3">
                {{ form.description }}
            </td>
        </tr>
        <tr>
            <td>
                <strong>{{ form.baseline_rel_evt.label_tag }}</strong>
            </td>
            <td>
                {{ form.baseline_rel_evt }}
            </td>
            <td>
                WOI type
            </td>
            <td>
                <select id="id_baseline_rel_type" name="baseline_rel_type" onchange="setWOIRelType('baseline')">
                    <option value="fixed" selected>Fixed duration</option>
                    <option value="relative">Relative duration</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>
                <div class="baseline_fixed">
                    {{ form.baseline_rel_start.label_tag }}
                </div>
                <div class="baseline_relative" style="display: none;">
                    {{ form.baseline_rel_end_evt.label_tag }}
                </div>
            </td>
            <td>
                <div class="baseline_fixed">
                    {{ form.baseline_rel_start }}
                </div>
                <div class="baseline_relative" style="display: none;">
                    {{ form.baseline_rel_end_evt }}
                </div>
            </td>
            <td>
                <div class="baseline_fixed">
                    {{ form.baseline_rel_end.label_tag }}
                </div>
            </td>
            <td>
                <div class="baseline_fixed">
                    {{ form.baseline_rel_end }}
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <strong>{{ form.obj_view_woi_rel_evt.label_tag }}</strong>
            </td>
            <td>
                {{ form.obj_view_woi_rel_evt }}
            </td>
            <td>
                WOI type
            </td>
            <td>
                <select id="id_obj_view_woi_rel_type" name="obj_view_woi_rel_type" onchange="setWOIRelType('obj_view_woi')">
                    <option value="fixed" selected>Fixed duration</option>
                    <option value="relative">Relative duration</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>
                <div class="obj_view_woi_fixed">
                    {{ form.obj_view_woi_rel_start.label_tag }}
                </div>
                <div class="obj_view_woi_relative" style="display: none;">
                    {{ form.obj_view_woi_rel_end_evt.label_tag }}
                </div>
            </td>
            <td>
                <div class="obj_view_woi_fixed">
                    {{ form.obj_view_woi_rel_start }}
                </div>
                <div class="obj_view_woi_relative" style="display: none;">
                    {{ form.obj_view_woi_rel_end_evt }}
                </div>
            </td>
            <td>
                <div class="obj_view_woi_fixed">
                    {{ form.obj_view_woi_rel_end.label_tag }}
                </div>
            </td>
            <td>
                <div class="obj_view_woi_fixed">
                    {{ form.obj_view_woi_rel_end }}
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <strong>{{ form.grasp_woi_rel_evt.label_tag }}</strong>
            </td>
            <td>
                {{ form.grasp_woi_rel_evt }}
            </td>
            <td>
                WOI type
            </td>
            <td>
                <select id="id_grasp_woi_rel_type" name="grasp_woi_rel_type" onchange="setWOIRelType('grasp_woi')">
                    <option value="fixed" selected>Fixed duration</option>
                    <option value="relative">Relative duration</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>
                <div class="grasp_woi_fixed">
                    {{ form.grasp_woi_rel_start.label_tag }}
                </div>
                <div class="grasp_woi_relative" style="display: none;">
                    {{ form.grasp_woi_rel_end_evt.label_tag }}
                </div>
            </td>
            <td>
                <div class="grasp_woi_fixed">
                    {{ form.grasp_woi_rel_start }}
                </div>
                <div class="grasp_woi_relative" style="display: none;">
                    {{ form.grasp_woi_rel_end_evt }}
                </div>
            </td>
            <td>
                <div class="grasp_woi_fixed">
                    {{ form.grasp_woi_rel_end.label_tag }}
                </div>
            </td>
            <td>
                <div class="grasp_woi_fixed">
                    {{ form.grasp_woi_rel_end }}
                </div>
            </td>
        </tr>
    </table>
    <h3>Factor Level - Condition Mappings</h3>
    <table>
        <tr>
            <td><strong>Factor</strong></td>
            <td><strong>Level</strong></td>
            <td><strong>Conditions</strong></td>
        </tr>
        {% for factor in factors %}
            <tr>
                <td>{{ factor.name }}</td>
                <td></td>
                <td></td>
            </tr>
            {% for level in factor.levels.all %}
            <tr>
                <td></td>
                <td>{{ level.value }}</td>
                <td>
                    <select id="id_level_mapping_{{ level.id }}" name="level_mapping_{{ level.id }}" multiple size="5">
                        {% for condition in conditions %}
                            <option value="{{ condition.id }}">{{ condition.name }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            {% endfor %}
        {% endfor %}
    </table>
    {{ form.analysis }}
    {{ form.experiment }}
    <input type="submit" value="Run" />
</form>
{% endblock %}
